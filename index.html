<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suite Gamifikasi</title>
    <!-- Library untuk membaca file Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Library untuk efek konfeti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card-selected { transform: scale(1.05); box-shadow: 0 0 0 4px #3b82f6; border-color: #3b82f6; }
        .score-update-pop { animation: pop 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        @keyframes pop { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .scroll-panel::-webkit-scrollbar { width: 8px; }
        .scroll-panel::-webkit-scrollbar-track { background: transparent; }
        .scroll-panel::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .main-menu-item.active { background-color: #3b82f6; color: white; }
        .badge-icon, .race-icon { transition: all 0.3s; }
        .badge-icon:hover { transform: scale(1.2); }
        .modal-enter { animation: modal-in 0.3s ease-out; }
        @keyframes modal-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        #main-sidebar { transition: width 0.3s ease-in-out; }
        #main-sidebar.collapsed .menu-text, #main-sidebar.collapsed #main-logo-text { display: none; }
        #main-sidebar.collapsed .justify-center { justify-content: center; }
        .progress-bar { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .race-icon { filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); }
        #wheelCanvas { transition: transform 5s cubic-bezier(.17,.93,.38,1); }
        .timer-display.ending { animation: flash-red 1s infinite; }
        @keyframes flash-red { 50% { color: #ef4444; } }
        #panel-timer:fullscreen #timer-controls-wrapper { display: none; }
        #panel-timer:fullscreen { display: flex; align-items: center; justify-content: center; background-color: #1e293b; }
        #panel-timer:fullscreen #timer-display { font-size: 25vw; margin: 0; color: white;}
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="flex h-screen">
        <!-- Sidebar Menu Utama (Kiri) -->
        <aside id="main-sidebar" class="bg-slate-800 text-slate-200 p-4 flex flex-col flex-shrink-0">
            <h1 class="flex items-center justify-center text-2xl font-bold text-white text-center mb-10"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7 mr-2 flex-shrink-0 text-amber-400"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.007z" clip-rule="evenodd" /></svg><span id="main-logo-text" class="menu-text">GAMECLASS</span></h1>
            <nav class="flex flex-col space-y-2">
                <p class="px-4 pt-4 pb-2 text-xs uppercase text-slate-500 menu-text">Mode Game</p>
                <a href="#" id="menu-individu" class="main-menu-item flex items-center py-2 px-4 rounded-lg transition-colors duration-200 hover:bg-slate-700 active"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg><span class="menu-text">Game Individu</span></a>
                <a href="#" id="menu-grup" class="main-menu-item flex items-center py-2 px-4 rounded-lg transition-colors duration-200 hover:bg-slate-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.122-1.28-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.122-1.28.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg><span class="menu-text">Game Grup</span></a>
                <a href="#" id="menu-fortune-wheel" class="main-menu-item flex items-center py-2 px-4 rounded-lg transition-colors duration-200 hover:bg-slate-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.552 8.052a3.375 3.375 0 015.254 0 3.375 3.375 0 010 5.254M4.194 18.948a3.375 3.375 0 010-5.254 3.375 3.375 0 015.254 0M18.948 4.194a3.375 3.375 0 010 5.254 3.375 3.375 0 01-5.254 0M8.052 15.552a3.375 3.375 0 01-5.254 0 3.375 3.375 0 010-5.254M12 18.75a.75.75 0 00.75-.75V12a.75.75 0 00-1.5 0v6a.75.75 0 00.75.75z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 5.25a.75.75 0 01.75-.75h.01a.75.75 0 01.75.75v.01a.75.75 0 01-.75.75h-.01a.75.75 0 01-.75-.75V5.25zM18.75 12a.75.75 0 00-.75.75v.01a.75.75 0 001.5 0V12a.75.75 0 00-.75-.75zM5.25 12a.75.75 0 01-.75.75v.01a.75.75 0 011.5 0V12a.75.75 0 01-.75-.75z" /></svg><span class="menu-text">Roda Keberuntungan</span></a>
                <a href="#" id="menu-timer" class="main-menu-item flex items-center py-2 px-4 rounded-lg transition-colors duration-200 hover:bg-slate-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span class="menu-text">Timer</span></a>

                <p class="px-4 pt-4 pb-2 text-xs uppercase text-slate-500 menu-text">Manajemen</p>
                <a href="#" id="menu-sesi-baru" class="main-menu-item flex items-center py-2 px-4 rounded-lg transition-colors duration-200 hover:bg-slate-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span class="menu-text">Sesi Baru (Excel)</span></a>
                <a href="#" id="menu-lanjutkan-sesi" class="main-menu-item flex items-center py-2 px-4 rounded-lg transition-colors duration-200 hover:bg-slate-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg><span class="menu-text">Lanjutkan Sesi</span></a>
                <a href="#" id="menu-simpan-sesi" class="main-menu-item flex items-center py-2 px-4 rounded-lg transition-colors duration-200 hover:bg-slate-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg><span class="menu-text">Simpan Sesi</span></a>
                <a href="#" id="menu-pengaturan" class="main-menu-item flex items-center py-2 px-4 rounded-lg transition-colors duration-200 hover:bg-slate-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span class="menu-text">Pengaturan</span></a>
            </nav>
            <div class="mt-auto pt-4 border-t border-slate-700 flex flex-col items-center justify-center">
                <footer class="mb-2 text-xs text-center text-slate-500 menu-text">Made with ‚ù§Ô∏è ¬©Ô∏ètamawith.ai 2025</footer>
                <button id="sidebar-toggle" type="button" class="text-slate-400 hover:text-white hover:bg-slate-700 focus:outline-none rounded-lg text-sm p-2.5"><svg id="sidebar-toggle-close-icon" class="hidden w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg><svg id="sidebar-toggle-open-icon" class="hidden w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
            </div>
        </aside>

        <!-- === KONTEN UTAMA === -->
        <div id="main-content" class="flex-1 overflow-hidden">
            
            <!-- == PANEL GAME INDIVIDU == -->
            <div id="panel-individu" class="flex h-full">
                <main class="flex-1 flex flex-col p-4 sm:p-6 lg:p-8 overflow-y-auto">
                    <header class="mb-6"><h1 class="text-3xl font-bold text-slate-800">Panel Partisipasi</h1><p class="text-slate-500">Pilih peserta, lalu berikan poin & raih badge!</p></header>
                    <div id="peserta-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-5 flex-1"></div>
                    <div id="controls-panel" class="mt-6 p-4 bg-white rounded-xl shadow-lg"><h3 id="controls-title" class="text-lg font-semibold text-center text-slate-600 mb-3">Muat data peserta atau pilih peserta.</h3><div id="point-buttons-container" class="flex flex-wrap justify-center gap-3"></div></div>
                </main>
                <aside class="w-80 bg-white/50 p-6 flex flex-col border-l border-slate-200 flex-shrink-0">
                    <div class="flex-1 flex flex-col min-h-0"><h2 class="text-2xl font-bold mb-4 text-slate-800 text-center flex-shrink-0">üèÜ Papan Peringkat</h2><div id="leaderboard-sidebar" class="scroll-panel flex-grow overflow-y-auto pr-2 space-y-3"></div></div>
                    <div class="flex-1 flex flex-col min-h-0 mt-6 pt-6 border-t border-slate-200"><h2 class="text-2xl font-bold mb-4 text-slate-800 text-center flex-shrink-0">üèÖ Badge Diraih</h2><div id="badge-panel-sidebar" class="scroll-panel flex-grow overflow-y-auto pr-2 space-y-3"></div></div>
                </aside>
            </div>

            <!-- == PANEL GAME GRUP (AMAZING RACE) == -->
            <div id="panel-grup" class="hidden h-full flex flex-col bg-slate-900 text-white">
                <div id="setup-screen" class="p-8 max-w-2xl mx-auto my-auto"><h1 class="text-4xl font-extrabold text-center mb-2">üèÅ Amazing Race</h1><p class="text-center text-slate-400 mb-8">Atur tim dan ikon untuk memulai balapan!</p><form id="setup-form" class="bg-slate-800 p-8 rounded-2xl shadow-2xl"><div class="mb-6"><label for="team-count" class="block mb-2 text-sm font-medium text-slate-300">Jumlah Tim (2-8)</label><input type="number" id="team-count" value="2" min="2" max="8" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"></div><div id="team-details-container" class="space-y-4 mb-8"></div><button type="submit" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-bold rounded-lg text-lg px-5 py-3 text-center">Mulai Balapan!</button></form></div>
                <div id="race-screen" class="hidden p-4 sm:p-8 h-full flex flex-col"><header class="flex justify-between items-center mb-6 flex-shrink-0"><h1 class="text-3xl font-extrabold">Race in Progress</h1><button id="reset-race-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Reset & Mulai Baru</button></header><main id="race-tracks" class="flex-grow space-y-4 overflow-y-auto pr-4"></main><footer id="race-controls" class="pt-6 border-t border-slate-700 mt-4 flex-shrink-0"><h2 class="text-center font-bold mb-3">Kontrol Poin</h2><div id="control-buttons" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4"></div></footer></div>
            </div>

             <!-- == PANEL FORTUNE WHEEL == -->
             <div id="panel-fortune-wheel" class="hidden h-full flex flex-col items-center justify-center p-8 bg-gray-200">
                <h1 class="text-4xl font-extrabold text-slate-800 mb-4">Roda Keberuntungan</h1>
                <div id="wheel-container" class="relative"><canvas id="wheelCanvas" width="500" height="500"></canvas><div class="absolute top-0 left-1/2 -translate-x-1/2" style="filter: drop-shadow(0px 4px 3px rgba(0,0,0,0.3));"><svg width="30" height="45" viewBox="0 0 30 45" xmlns="http://www.w3.org/2000/svg"><polygon points="15,45 0,0 30,0" fill="white"/></svg></div></div>
                <button id="spin-btn" class="mt-8 bg-blue-600 text-white font-bold py-4 px-10 rounded-full text-xl shadow-lg hover:bg-blue-700 disabled:bg-slate-400 disabled:cursor-not-allowed">Putar Roda!</button>
             </div>
             
             <!-- == PANEL TIMER == -->
             <div id="panel-timer" class="flex h-full flex-col items-center justify-center p-8 bg-slate-800 text-white">
                <div id="timer-wrapper" class="text-center">
                    <div id="timer-display" class="font-mono text-9xl font-black mb-6">00:00</div>
                    <div id="timer-controls-wrapper">
                        <h1 class="text-3xl font-bold mb-4">Pengatur Waktu</h1>
                        <div class="flex items-center justify-center gap-4 mb-6">
                            <button data-time="60" class="timer-set-btn bg-sky-500 hover:bg-sky-600 font-bold py-2 px-4 rounded-lg">1 Menit</button>
                            <button data-time="300" class="timer-set-btn bg-sky-500 hover:bg-sky-600 font-bold py-2 px-4 rounded-lg">5 Menit</button>
                            <button data-time="600" class="timer-set-btn bg-sky-500 hover:bg-sky-600 font-bold py-2 px-4 rounded-lg">10 Menit</button>
                        </div>
                        <div class="flex items-center justify-center gap-4 mb-8">
                            <label for="custom-time-input">Kustom (menit):</label>
                            <input type="number" id="custom-time-input" min="1" class="bg-slate-700 border border-slate-600 rounded-lg w-24 p-2 text-center">
                            <button id="custom-time-btn" class="bg-indigo-500 hover:bg-indigo-600 font-bold py-2 px-4 rounded-lg">Atur</button>
                        </div>
                        <div class="flex items-center justify-center gap-4">
                            <button id="timer-toggle-btn" class="bg-green-600 hover:bg-green-700 font-bold py-3 px-6 rounded-lg text-lg w-32">Mulai</button>
                            <button id="timer-reset-btn" class="bg-red-600 hover:bg-red-700 font-bold py-3 px-6 rounded-lg text-lg">Reset</button>
                            <button id="timer-fullscreen-btn" class="bg-gray-500 hover:bg-gray-600 font-bold p-3 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1v4m0 0h-4m4-4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg></button>
                        </div>
                    </div>
                </div>
             </div>

        </div>
    </div>

    <!-- === KUMPULAN MODAL === -->
    <div id="upload-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4"><div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg relative modal-enter"><button id="close-upload-modal-btn" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800">&times;</button><h2 class="text-2xl font-bold mb-4">Unggah File Data Peserta</h2><div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-r-lg mb-6"><p class="font-bold">Struktur File Excel (.xlsx):</p><ul class="list-disc list-inside mt-2 text-sm"><li>Baris pertama harus berisi judul kolom (Header).</li><li>Kolom A harus berjudul <strong>Nama</strong>.</li><li>Kolom B harus berjudul <strong>Avatar</strong> (berisi link URL gambar).</li></ul></div><input type="file" id="excel-file-input" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/><p id="upload-status" class="text-sm mt-4 text-center"></p></div></div>
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4"><div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg relative modal-enter"><button id="close-settings-modal-btn" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800">&times;</button><div id="settings-form-content"></div></div></div>
    <div id="badge-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center relative modal-enter"><div id="badge-icon-container" class="text-7xl mb-4"></div><p class="text-lg text-slate-500">Selamat kepada</p><h2 id="badge-participant-name" class="text-3xl font-bold my-2"></h2><p class="text-lg text-slate-500">telah meraih badge</p><h3 id="badge-name" class="text-2xl font-bold text-blue-500 mt-2"></h3><button id="close-badge-modal-btn" class="mt-8 bg-blue-500 text-white font-bold py-2 px-6 rounded-full hover:bg-blue-600">Lanjutkan!</button></div></div>
    <div id="winner-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4"><div class="bg-slate-800 border-2 border-amber-400 rounded-2xl shadow-2xl p-8 w-full max-w-md text-center relative modal-enter"><div id="winner-icon" class="text-8xl mb-4 scale-150"></div><p class="text-2xl text-slate-400">Pemenangnya adalah...</p><h2 id="winner-name" class="text-5xl font-black my-4 text-amber-300 uppercase"></h2><button id="restart-from-winner-btn" class="mt-8 bg-blue-600 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-700">Mulai Balapan Baru</button></div></div>
    <div id="wheel-winner-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl p-12 w-full max-w-md text-center relative modal-enter"><img id="wheel-winner-avatar" src="" class="w-32 h-32 rounded-full object-cover mx-auto mb-4 border-4 border-amber-400 shadow-lg"><h2 id="wheel-winner-name" class="text-4xl font-black my-4 text-slate-800"></h2><button id="close-wheel-winner-btn" class="mt-8 bg-blue-600 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-700">Tutup</button></div></div>

    <script>
    window.onload = function() {
        // === BAGIAN KONTROL UTAMA & NAVIGASI ===
        const panelIndividu = document.getElementById('panel-individu');
        const panelGrup = document.getElementById('panel-grup');
        const panelFortuneWheel = document.getElementById('panel-fortune-wheel');
        const panelTimer = document.getElementById('panel-timer');
        const menuIndividu = document.getElementById('menu-individu');
        const menuGrup = document.getElementById('menu-grup');
        const menuFortuneWheel = document.getElementById('menu-fortune-wheel');
        const menuTimer = document.getElementById('menu-timer');
        const allPanels = [panelIndividu, panelGrup, panelFortuneWheel, panelTimer];
        const setActiveMenu = (activeMenu) => { document.querySelectorAll('.main-menu-item').forEach(el => el.classList.remove('active')); if (activeMenu) activeMenu.classList.add('active'); };
        const showPanel = (panelId) => { allPanels.forEach(p => p.classList.add('hidden')); let activeMenu; if (panelId === 'individu') { panelIndividu.classList.remove('hidden'); activeMenu = menuIndividu; } else if (panelId === 'grup') { panelGrup.classList.remove('hidden'); activeMenu = menuGrup; } else if (panelId === 'fortune-wheel') { panelFortuneWheel.classList.remove('hidden'); activeMenu = menuFortuneWheel; drawFortuneWheel(); } else if (panelId === 'timer') { panelTimer.classList.remove('hidden'); activeMenu = menuTimer; } setActiveMenu(activeMenu); };
        menuIndividu.addEventListener('click', (e) => { e.preventDefault(); showPanel('individu'); });
        menuGrup.addEventListener('click', (e) => { e.preventDefault(); showPanel('grup'); });
        menuFortuneWheel.addEventListener('click', (e) => { e.preventDefault(); showPanel('fortune-wheel'); });
        menuTimer.addEventListener('click', (e) => { e.preventDefault(); showPanel('timer'); });
        const sidebar = document.getElementById('main-sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const openIcon = document.getElementById('sidebar-toggle-open-icon');
        const closeIcon = document.getElementById('sidebar-toggle-close-icon');
        const setSidebarState = (isCollapsed) => { sidebar.classList.toggle('collapsed', isCollapsed); sidebar.style.width = isCollapsed ? '80px' : '256px'; if(openIcon) openIcon.classList.toggle('hidden', !isCollapsed); if(closeIcon) closeIcon.classList.toggle('hidden', isCollapsed); localStorage.setItem('sidebar-collapsed', isCollapsed); };
        const initializeSidebar = () => { setSidebarState(localStorage.getItem('sidebar-collapsed') === 'true'); };
        initializeSidebar();
        if(sidebarToggle){ sidebarToggle.addEventListener('click', () => { setSidebarState(!sidebar.classList.contains('collapsed')); }); }

        // === BAGIAN MANAJEMEN SESI ===
        const menuSesiBaru = document.getElementById('menu-sesi-baru');
        const menuLanjutkanSesi = document.getElementById('menu-lanjutkan-sesi');
        const menuSimpanSesi = document.getElementById('menu-simpan-sesi');
        
        menuSesiBaru.addEventListener('click', (e) => { e.preventDefault(); uploadModal.classList.remove('hidden'); });
        menuLanjutkanSesi.addEventListener('click', (e) => { e.preventDefault(); sessionFileInput.click(); });
        menuSimpanSesi.addEventListener('click', (e) => { e.preventDefault(); saveSession(); });

        const sessionFileInput = document.createElement('input');
        sessionFileInput.type = 'file';
        sessionFileInput.accept = '.json';
        sessionFileInput.style.display = 'none';
        document.body.appendChild(sessionFileInput);
        sessionFileInput.addEventListener('change', loadSession);
        
        function saveSession() {
            if (peserta.length === 0) { alert('Tidak ada data sesi untuk disimpan.'); return; }
            const sessionData = { peserta };
            const dataStr = JSON.stringify(sessionData, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.download = `sesi-gamifikasi-${new Date().toISOString().slice(0,10)}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        }

        function loadSession(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const sessionData = JSON.parse(e.target.result);
                    if (sessionData && sessionData.peserta) {
                        peserta = sessionData.peserta;
                        renderSemua();
                        alert('Sesi berhasil dimuat!');
                    } else { throw new Error('Format file tidak valid.'); }
                } catch (err) { alert('Gagal memuat file sesi. Pastikan file valid.'); console.error(err); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // === BAGIAN GAME INDIVIDU & PENGATURAN ===
        let peserta = []; let pesertaTerpilihId = null;
        let soundSettings = { point: '', badge: '' };
        const gridContainer = document.getElementById('peserta-grid');
        const leaderboardContainer = document.getElementById('leaderboard-sidebar');
        const badgePanelContainer = document.getElementById('badge-panel-sidebar');
        const controlsTitle = document.getElementById('controls-title');
        const pointButtonsContainer = document.getElementById('point-buttons-container');
        const uploadModal = document.getElementById('upload-modal');
        const closeUploadModalBtn = document.getElementById('close-upload-modal-btn');
        const fileInput = document.getElementById('excel-file-input');
        const uploadStatus = document.getElementById('upload-status');
        const badgeModal = document.getElementById('badge-modal');
        const closeBadgeModalBtn = document.getElementById('close-badge-modal-btn');
        const menuPengaturan = document.getElementById('menu-pengaturan');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsModalBtn = document.getElementById('close-settings-modal-btn');
        const settingsFormContent = document.getElementById('settings-form-content');
        let TipePoin = [ { key: 'tanya', label: 'Bertanya', nilai: 5, warna: 'bg-sky-500 hover:bg-sky-600' }, { key: 'jawab', label: 'Menjawab', nilai: 10, warna: 'bg-emerald-500 hover:bg-emerald-600' }, { key: 'sharing', label: 'Sharing', nilai: 15, warna: 'bg-amber-500 hover:bg-amber-600' }, { key: 'praktik', label: 'Sukarelawan Praktik', nilai: 20, warna: 'bg-indigo-500 hover:bg-indigo-600' } ];
        const SistemBadge = { tanya: { ikon: 'üß†', tingkat: { 5: 'Pemikir Kritis', 10: 'Pakar Penanya', 15: 'Inkuisitor Ulung' } }, jawab: { ikon: 'üí°', tingkat: { 5: 'Sang Pencerah', 10: 'Sumber Pengetahuan', 15: 'Pustakawan Berjalan' } }, sharing: { ikon: '‚ù§Ô∏è', tingkat: { 5: 'Pembagi Cerita', 10: 'Inspirator Sesi', 15: 'Mentor Sejawat' } }, praktik: { ikon: 'üöÄ', tingkat: { 5: 'Sang Pemberani', 10: 'Pelopor Aksi', 15: 'Ahli Panggung' } } };
        
        function playSound(url) {
            if (url) {
                try {
                    const audio = new Audio(url);
                    audio.play();
                } catch(e) {
                    console.error("Gagal memutar audio:", e);
                }
            }
        }
        
        function loadSettings() { 
            const savedPoints = localStorage.getItem('gamifikasi-custom-points');
            const savedSounds = localStorage.getItem('gamifikasi-custom-sounds');
            if (savedPoints) TipePoin = JSON.parse(savedPoints);
            if (savedSounds) soundSettings = JSON.parse(savedSounds);
        }
        function populateSettingsForm() {
            settingsFormContent.innerHTML = '';
            let formHTML = `<h3 class="text-xl font-bold mb-4">Pengaturan Nilai Poin</h3><form id="settings-form-points" class="space-y-4">`;
            TipePoin.forEach(tipe => {
                formHTML += `<div class="flex items-center justify-between"><label for="setting-${tipe.key}" class="font-medium text-slate-700">${tipe.label}</label><input type="number" id="setting-${tipe.key}" name="${tipe.key}" value="${tipe.nilai}" class="w-24 p-2 border border-slate-300 rounded-md"></div>`;
            });
            formHTML += `</form><hr class="my-6"><h3 class="text-xl font-bold mb-4">Pengaturan Suara</h3><form id="settings-form-sounds" class="space-y-4">`;
            formHTML += `<div class="flex items-center justify-between"><label for="setting-sound-point" class="font-medium text-slate-700">Suara Poin (URL .mp3)</label><input type="url" id="setting-sound-point" value="${soundSettings.point}" class="w-2/3 p-2 border border-slate-300 rounded-md"></div>`;
            formHTML += `<div class="flex items-center justify-between"><label for="setting-sound-badge" class="font-medium text-slate-700">Suara Badge (URL .mp3)</label><input type="url" id="setting-sound-badge" value="${soundSettings.badge}" class="w-2/3 p-2 border border-slate-300 rounded-md"></div>`;
            formHTML += `</form><button id="save-settings-btn" class="w-full mt-6 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">Simpan Semua Pengaturan</button>`;
            settingsFormContent.innerHTML = formHTML;
            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
        }
        function saveSettings(event) { 
            event.preventDefault(); 
            TipePoin.forEach(tipe => { const input = document.getElementById(`setting-${tipe.key}`); if (input) tipe.nilai = parseInt(input.value, 10) || 0; }); 
            soundSettings.point = document.getElementById('setting-sound-point').value;
            soundSettings.badge = document.getElementById('setting-sound-badge').value;
            localStorage.setItem('gamifikasi-custom-points', JSON.stringify(TipePoin));
            localStorage.setItem('gamifikasi-custom-sounds', JSON.stringify(soundSettings));
            settingsModal.classList.add('hidden'); 
            renderControls(); 
        }
        function handleFileUpload(event) { const file = event.target.files[0]; if (!file) return; uploadStatus.textContent = 'Membaca file...'; const reader = new FileReader(); reader.onload = function(e) { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const sheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[sheetName]; const jsonData = XLSX.utils.sheet_to_json(worksheet); peserta = jsonData.map((row, index) => ({ id: index + 1, nama: row.Nama || 'Tanpa Nama', skor: 0, avatar: row.Avatar || 'https://placehold.co/128x128/E5E7EB/333333?text=??', tanyaCount: 0, jawabCount: 0, sharingCount: 0, praktikCount: 0, badges: [] })); uploadStatus.textContent = `${peserta.length} peserta berhasil dimuat!`; pesertaTerpilihId = null; renderSemua(); setTimeout(() => { uploadModal.classList.add('hidden'); uploadStatus.textContent = ''; fileInput.value = ''; }, 1500); } catch (err) { console.error("Error reading Excel file:", err); uploadStatus.textContent = 'Gagal memuat file.'; } }; reader.readAsArrayBuffer(file); }
        function beriPoin(nilai, key) { if (pesertaTerpilihId === null) return; playSound(soundSettings.point); const p = peserta.find(p => p.id === pesertaTerpilihId); if (p) { p.skor += nilai; if (p.skor < 0) p.skor = 0; const counterKey = key + 'Count'; if(p.hasOwnProperty(counterKey)) { p[counterKey]++; cekDanBeriBadge(p, key); } renderSemua(); const skorGrid = document.querySelector(`#card-${p.id} .skor`); const skorSide = document.getElementById(`side-skor-${p.id}`); [skorGrid, skorSide].forEach(el => { if(el) { el.classList.add('score-update-pop'); el.addEventListener('animationend', () => el.classList.remove('score-update-pop'), {once: true}); } }); } }
        function cekDanBeriBadge(p, key) { const count = p[key + 'Count']; const badgeInfo = SistemBadge[key]; if (!badgeInfo || count === 0 || count % 5 !== 0) return; const namaBadge = badgeInfo.tingkat[count]; if (!namaBadge) return; const sudahPunya = p.badges.some(b => b.nama === namaBadge); if (!sudahPunya) { p.badges.push({ nama: namaBadge, ikon: badgeInfo.ikon }); tampilkanNotifikasiBadge(p.nama, namaBadge, badgeInfo.ikon); } }
        function tampilkanNotifikasiBadge(namaPeserta, namaBadge, ikonBadge) { playSound(soundSettings.badge); confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); document.getElementById('badge-participant-name').textContent = namaPeserta; document.getElementById('badge-name').textContent = namaBadge; document.getElementById('badge-icon-container').innerHTML = ikonBadge; badgeModal.classList.remove('hidden'); }
        function pilihPeserta(id) { pesertaTerpilihId = (pesertaTerpilihId === id) ? null : id; renderSemua(); }
        function renderGridPeserta() { gridContainer.innerHTML = ''; if (peserta.length === 0) { gridContainer.innerHTML = `<p class="text-center col-span-full text-slate-500">Mulai dengan "Sesi Baru" atau "Lanjutkan Sesi".</p>`; return; } peserta.forEach(p => { const isSelected = p.id === pesertaTerpilihId; const card = document.createElement('div'); card.id = `card-${p.id}`; card.className = `p-3 bg-white rounded-xl shadow-md cursor-pointer transition-all duration-300 ease-in-out flex flex-col items-center border-2 ${isSelected ? 'card-selected' : 'border-transparent'}`; card.onclick = () => pilihPeserta(p.id); const badgesHTML = p.badges.map(b => `<span class="badge-icon text-2xl" title="${b.nama}">${b.ikon}</span>`).join(''); card.innerHTML = `<img src="${p.avatar}" onerror="this.src='https://placehold.co/128x128/E5E7EB/333333?text=??'" alt="Avatar ${p.nama}" class="w-24 h-24 rounded-full object-cover"><h3 class="mt-3 font-semibold text-center text-slate-700">${p.nama}</h3><p class="skor text-2xl font-bold text-slate-800">${p.skor}</p><div class="flex space-x-2 mt-2 h-8 items-center">${badgesHTML}</div>`; gridContainer.appendChild(card); }); }
        function renderLeaderboard() { const dinilai = peserta.filter(p => p.skor > 0).sort((a, b) => b.skor - a.skor); const top10 = dinilai.slice(0, 10); leaderboardContainer.innerHTML = ''; if (dinilai.length === 0) { leaderboardContainer.innerHTML = `<p class="text-center text-sm text-slate-500">Belum ada penilaian.</p>`; return; } top10.forEach((p, index) => { const rank = index + 1; let medal = ''; if (rank === 1) medal = 'ü•á'; else if (rank === 2) medal = 'ü•à'; else if (rank === 3) medal = 'ü•â'; const item = document.createElement('div'); item.className = 'flex items-center p-3 bg-slate-100 rounded-lg'; item.innerHTML = `<span class="text-lg font-bold w-8 text-center">${medal || rank}</span><img src="${p.avatar}" onerror="this.src='https://placehold.co/128x128/E5E7EB/333333?text=??'" alt="${p.nama}" class="w-10 h-10 rounded-full mx-3"><span class="flex-1 font-medium text-slate-700 truncate">${p.nama}</span><span id="side-skor-${p.id}" class="skor font-bold text-lg text-slate-800">${p.skor}</span>`; leaderboardContainer.appendChild(item); }); }
        function renderBadgePanel() { const allBadges = peserta.flatMap(p => p.badges.map(b => ({ namaPeserta: p.nama, ...b }))).reverse(); badgePanelContainer.innerHTML = ''; if(allBadges.length === 0) { badgePanelContainer.innerHTML = `<p class="text-center text-sm text-slate-500">Belum ada badge.</p>`; return; } allBadges.forEach(badge => { const item = document.createElement('div'); item.className = 'flex items-center p-2 bg-slate-100 rounded-lg text-sm'; item.innerHTML = `<span class="text-xl w-8 text-center">${badge.ikon}</span><div class="flex-1 truncate"><p class="font-bold text-slate-700">${badge.namaPeserta}</p><p class="text-slate-500">${badge.nama}</p></div>`; badgePanelContainer.appendChild(item); }); }
        function renderControls() { const pesertaTerpilih = peserta.find(p => p.id === pesertaTerpilihId); if(pesertaTerpilih) { controlsTitle.innerHTML = `Memberi Poin untuk: <span class="font-bold text-blue-500">${pesertaTerpilih.nama}</span>`; } else if (peserta.length > 0) { controlsTitle.textContent = 'Pilih Peserta'; } else { controlsTitle.textContent = 'Muat data peserta'; } pointButtonsContainer.innerHTML = ''; TipePoin.forEach(tipe => { const button = document.createElement('button'); button.className = `point-btn text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center shadow-md disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105 active:scale-95 ${tipe.warna}`; button.onclick = () => beriPoin(tipe.nilai, tipe.key); button.disabled = pesertaTerpilihId === null; button.innerHTML = `${tipe.ikon || ''} ${tipe.label} (+${tipe.nilai})`; pointButtonsContainer.appendChild(button); }); }
        function renderSemua() { renderGridPeserta(); renderLeaderboard(); renderBadgePanel(); renderControls(); }
        closeUploadModalBtn.addEventListener('click', () => { uploadModal.classList.add('hidden'); uploadStatus.textContent = ''; });
        closeBadgeModalBtn.addEventListener('click', () => { badgeModal.classList.add('hidden'); });
        fileInput.addEventListener('change', handleFileUpload);
        menuPengaturan.addEventListener('click', (e) => { e.preventDefault(); populateSettingsForm(); settingsModal.classList.remove('hidden'); });
        closeSettingsModalBtn.addEventListener('click', () => { settingsModal.classList.add('hidden'); });
        loadSettings(); renderSemua();

        // === BAGIAN GAME GRUP ===
        let teams = [];
        const ICONS = { lion: { svg: 'ü¶Å', name: 'Singa' }, tiger: { svg: 'üêØ', name: 'Harimau' }, bear: { svg: 'üêª', name: 'Beruang' }, panda: { svg: 'üêº', name: 'Panda' }, fox: { svg: 'ü¶ä', name: 'Rubah' }, koala: { svg: 'üê®', name: 'Koala' }, dog: { svg: 'ÔøΩ', name: 'Anjing' }, cat: { svg: 'üê±', name: 'Kucing' } };
        const TEAM_COLORS = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899'];
        const ADVANCE_STEP = 10;
        const setupScreen = document.getElementById('setup-screen');
        const raceScreen = document.getElementById('race-screen');
        const setupForm = document.getElementById('setup-form');
        const teamCountInput = document.getElementById('team-count');
        const teamDetailsContainer = document.getElementById('team-details-container');
        const raceTracksContainer = document.getElementById('race-tracks');
        const controlButtonsContainer = document.getElementById('control-buttons');
        const resetRaceBtn = document.getElementById('reset-race-btn');
        const winnerModal = document.getElementById('winner-modal');
        const winnerIcon = document.getElementById('winner-icon');
        const winnerName = document.getElementById('winner-name');
        const restartFromWinnerBtn = document.getElementById('restart-from-winner-btn');
        function renderTeamSetupFields() { const count = parseInt(teamCountInput.value, 10); teamDetailsContainer.innerHTML = ''; const iconKeys = Object.keys(ICONS); for (let i = 0; i < count; i++) { let optionsHTML = iconKeys.map(key => `<option value="${key}" ${i === iconKeys.indexOf(key) ? 'selected' : ''}>${ICONS[key].svg} ${ICONS[key].name}</option>`).join(''); const fieldHTML = `<div class="grid grid-cols-12 gap-2 items-center"><label class="col-span-1 text-slate-400 font-bold text-center">${i + 1}</label><input type="text" placeholder="Nama Tim ${i + 1}" value="Tim ${i + 1}" required class="col-span-6 bg-slate-700 border border-slate-600 text-white text-sm rounded-lg p-2.5"><select class="col-span-5 bg-slate-700 border border-slate-600 text-white text-sm rounded-lg p-2.5">${optionsHTML}</select></div>`; teamDetailsContainer.insertAdjacentHTML('beforeend', fieldHTML); } }
        function startRace(event) { event.preventDefault(); teams = []; const detailRows = teamDetailsContainer.children; for (let i = 0; i < detailRows.length; i++) { const nameInput = detailRows[i].querySelector('input[type="text"]'); const iconSelect = detailRows[i].querySelector('select'); teams.push({ id: i, name: nameInput.value, icon: ICONS[iconSelect.value].svg, color: TEAM_COLORS[i % TEAM_COLORS.length], progress: 0, }); } setupScreen.classList.add('hidden'); raceScreen.classList.remove('hidden'); renderRace(); }
        function renderRace() { renderRaceTracks(); renderRaceControls(); }
        function renderRaceTracks() { raceTracksContainer.innerHTML = ''; teams.forEach(team => { const trackHTML = `<div class="space-y-2"><div class="flex justify-between items-center"><h3 class="font-bold text-lg">${team.icon} ${team.name}</h3><span class="text-sm font-mono text-slate-400">${team.progress}%</span></div><div class="w-full bg-slate-700 rounded-full h-8 relative"><div class="progress-bar h-8 rounded-full" style="width: ${team.progress}%; background-color: ${team.color};"></div><div class="race-icon text-4xl absolute top-1/2 -translate-y-1/2" style="left: calc(${team.progress}% - 24px);">${team.icon}</div></div></div>`; raceTracksContainer.insertAdjacentHTML('beforeend', trackHTML); }); }
        function renderRaceControls() { controlButtonsContainer.innerHTML = ''; teams.forEach(team => { const buttonHTML = `<button data-id="${team.id}" class="advance-btn text-white font-bold py-3 px-2 rounded-lg transition-transform hover:scale-105" style="background-color: ${team.color};">${team.icon} Maju!</button>`; controlButtonsContainer.insertAdjacentHTML('beforeend', buttonHTML); }); }
        function advanceTeam(event) { if (!event.target.classList.contains('advance-btn')) return; playSound(soundSettings.point); const teamId = parseInt(event.target.dataset.id, 10); const team = teams.find(t => t.id === teamId); if (team && team.progress < 100) { team.progress += ADVANCE_STEP; if (team.progress > 100) team.progress = 100; renderRaceTracks(); if (team.progress >= 100) { showWinner(team); } } }
        function showWinner(team) { playSound(soundSettings.badge); confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } }); winnerIcon.textContent = team.icon; winnerName.textContent = team.name; winnerModal.classList.remove('hidden'); controlButtonsContainer.removeEventListener('click', advanceTeam); controlButtonsContainer.querySelectorAll('button').forEach(btn => btn.disabled = true); }
        function resetGame() { teams = []; winnerModal.classList.add('hidden'); raceScreen.classList.add('hidden'); setupScreen.classList.remove('hidden'); renderTeamSetupFields(); controlButtonsContainer.addEventListener('click', advanceTeam); }
        teamCountInput.addEventListener('change', renderTeamSetupFields);
        setupForm.addEventListener('submit', startRace);
        controlButtonsContainer.addEventListener('click', advanceTeam);
        resetRaceBtn.addEventListener('click', resetGame);
        restartFromWinnerBtn.addEventListener('click', resetGame);
        renderTeamSetupFields();

        // === BAGIAN FORTUNE WHEEL ===
        const wheelCanvas = document.getElementById('wheelCanvas');
        const spinBtn = document.getElementById('spin-btn');
        const wheelWinnerModal = document.getElementById('wheel-winner-modal');
        const closeWheelWinnerBtn = document.getElementById('close-wheel-winner-btn');
        const wheelColors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#6366F1', '#22C55E', '#D946EF', '#0EA5E9'];
        let startAngle = 0; let spinTimeout = null; let spinAngleStart = 10; let spinTime = 0; let spinTimeTotal = 0;
        
        function getInitials(name) { if (!name) return ''; const words = name.split(' '); if (words.length > 1) { return (words[0][0] + words[words.length - 1][0]).toUpperCase(); } return name.substring(0, 2).toUpperCase(); }
        function drawFortuneWheel() { if (!wheelCanvas) return; const ctx = wheelCanvas.getContext('2d'); const arc = peserta.length > 0 ? Math.PI / (peserta.length / 2) : 0; ctx.clearRect(0, 0, 500, 500); ctx.strokeStyle = "#fff"; ctx.lineWidth = 2; if (peserta.length === 0) { ctx.fillStyle = "#94a3b8"; ctx.textAlign = "center"; ctx.font = '20px Inter, sans-serif'; ctx.fillText("Unggah data peserta untuk memulai", 250, 250); spinBtn.disabled = true; return; } spinBtn.disabled = false; for(let i = 0; i < peserta.length; i++) { const angle = startAngle + i * arc; ctx.fillStyle = wheelColors[i % wheelColors.length]; ctx.beginPath(); ctx.arc(250, 250, 250, angle, angle + arc, false); ctx.arc(250, 250, 0, angle + arc, angle, true); ctx.stroke(); ctx.fill(); ctx.save(); ctx.fillStyle = "white"; ctx.translate(250 + Math.cos(angle + arc / 2) * 160, 250 + Math.sin(angle + arc / 2) * 160); ctx.rotate(angle + arc / 2 + Math.PI / 2); const text = getInitials(peserta[i].nama); ctx.font = 'bold 32px Inter, sans-serif'; ctx.textAlign = 'center'; ctx.fillText(text, 0, 10); ctx.restore(); } }
        function rotateWheel() { spinTime += 30; if(spinTime >= spinTimeTotal) { stopRotateWheel(); return; } const spinAngle = spinAngleStart - easeOut(spinTime, 0, spinAngleStart, spinTimeTotal); startAngle += (spinAngle * Math.PI / 180); drawFortuneWheel(); spinTimeout = setTimeout(rotateWheel, 30); }
        function stopRotateWheel() { clearTimeout(spinTimeout); const degrees = startAngle * 180 / Math.PI + 90; const arcd = 360 / peserta.length; const index = Math.floor((360 - degrees % 360) / arcd); const winner = peserta[index]; showWheelWinner(winner); spinBtn.disabled = false; }
        function easeOut(t, b, c, d) { const ts = (t/=d)*t; const tc = ts*t; return b+c*(tc + -3*ts + 3*t); }
        function showWheelWinner(winner){ playSound(soundSettings.badge); confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } }); document.getElementById('wheel-winner-avatar').src = winner.avatar; document.getElementById('wheel-winner-name').textContent = winner.nama; wheelWinnerModal.classList.remove('hidden'); }
        spinBtn.addEventListener('click', () => { if (peserta.length === 0) return; spinAngleStart = Math.random() * 10 + 10; spinTime = 0; spinTimeTotal = Math.random() * 3 + 4 * 1000; spinBtn.disabled = true; rotateWheel(); });
        closeWheelWinnerBtn.addEventListener('click', () => wheelWinnerModal.classList.add('hidden'));
        
        // === BAGIAN TIMER ===
        const timerDisplay = document.getElementById('timer-display');
        const timerToggleBtn = document.getElementById('timer-toggle-btn');
        const timerResetBtn = document.getElementById('timer-reset-btn');
        const customTimeInput = document.getElementById('custom-time-input');
        const customTimeBtn = document.getElementById('custom-time-btn');
        const timerFullscreenBtn = document.getElementById('timer-fullscreen-btn');
        const timerControlsWrapper = document.getElementById('timer-controls-wrapper');
        let timerInterval = null;
        let timeRemaining = 0;
        let totalTime = 0;

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            if(timeRemaining <= 10 && timeRemaining > 0) timerDisplay.classList.add('ending');
            else timerDisplay.classList.remove('ending');
        }

        function setAndResetTimer(duration) {
             clearInterval(timerInterval);
             timerInterval = null;
             timeRemaining = duration;
             totalTime = duration;
             updateTimerDisplay();
             timerToggleBtn.textContent = 'Mulai';
        }

        function startTimer() {
            if(timeRemaining <= 0) return;
            timerToggleBtn.textContent = 'Jeda';
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    timerToggleBtn.textContent = 'Selesai';
                    confetti({ particleCount: 200, spread: 120, origin: { y: 0.8 }});
                }
            }, 1000);
        }

        document.querySelectorAll('.timer-set-btn').forEach(button => {
            button.addEventListener('click', () => {
                const seconds = parseInt(button.dataset.time, 10);
                setAndResetTimer(seconds);
            });
        });

        customTimeBtn.addEventListener('click', () => {
            const minutes = parseInt(customTimeInput.value, 10);
            if(minutes > 0){
                setAndResetTimer(minutes * 60);
            }
        });
        
        timerToggleBtn.addEventListener('click', () => {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                timerToggleBtn.textContent = 'Lanjut';
            } else {
                startTimer();
            }
        });

        timerResetBtn.addEventListener('click', () => {
            setAndResetTimer(totalTime);
        });

        timerFullscreenBtn.addEventListener('click', () => {
            const timerPanel = document.getElementById('panel-timer');
            if (!document.fullscreenElement) {
                timerPanel.requestFullscreen().catch(err => {
                    alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            } else {
                document.exitFullscreen();
            }
        });

    };
    </script>
</body>
</html>
ÔøΩ